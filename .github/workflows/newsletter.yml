name: Send Newsletter on New Post

on:
  push:
    branches:
      - main  # Change to your default branch if different
    paths:
      - '_posts/**'  # Trigger only when posts are added/modified

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    if: github.repository == 'dolphindonglers/website'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits to compare
      
      - name: Check for new posts
        id: check_new_post
        run: |
          # Get list of added files (not modified) in _posts directory
          NEW_POSTS=$(git diff --name-only --diff-filter=A HEAD^ HEAD | grep '^_posts/' | grep -E '\.(md|markdown)$' || true)
          
          if [ -z "$NEW_POSTS" ]; then
            echo "No new posts found (only updates or deletions)"
            echo "new_post=false" >> $GITHUB_OUTPUT
          else
            echo "New post(s) found:"
            echo "$NEW_POSTS"
            # Get the first new post (you can modify to handle multiple)
            LATEST_POST=$(echo "$NEW_POSTS" | head -n 1)
            echo "new_post=true" >> $GITHUB_OUTPUT
            echo "post_file=$LATEST_POST" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract post metadata
        if: steps.check_new_post.outputs.new_post == 'true'
        id: extract_metadata
        run: |
          POST_FILE="${{ steps.check_new_post.outputs.post_file }}"
          
          # Extract title from front matter
          TITLE=$(grep -m 1 '^title:' "$POST_FILE" | sed 's/title: *//; s/^"//; s/"$//')
          
          # Extract excerpt or description
          EXCERPT=$(grep -m 1 '^excerpt:\|^description:' "$POST_FILE" | sed 's/excerpt: *//; s/description: *//; s/^"//; s/"$//')
          
          # Extract date from filename (YYYY-MM-DD-title.md format)
          FILENAME=$(basename "$POST_FILE")
          POST_DATE=$(echo "$FILENAME" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')
          
          # Generate post URL (adjust YOUR_SITE_URL to your actual Jekyll site URL)
          POST_SLUG=$(echo "$FILENAME" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//; s/\.(md|markdown)$//')
          YEAR=$(echo "$POST_DATE" | cut -d- -f1)
          MONTH=$(echo "$POST_DATE" | cut -d- -f2)
          DAY=$(echo "$POST_DATE" | cut -d- -f3)
          POST_URL="https://dolphindonglers.github.io/blog/$YEAR-$MONTH-$DAY-$POST_SLUG"
      
      - name: Setup Python
        if: steps.check_new_post.outputs.new_post == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        if: steps.check_new_post.outputs.new_post == 'true'
        run: |
          pip install requests markdown
      
      - name: Send email via Buttondown
        if: steps.check_new_post.outputs.new_post == 'true'
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          POST_TITLE: ${{ steps.extract_metadata.outputs.title }}
          POST_EXCERPT: ${{ steps.extract_metadata.outputs.excerpt }}
          POST_URL: ${{ steps.extract_metadata.outputs.post_url }}
        run: |
          python - <<'EOF'
          import os
          import requests
          import markdown

          # Prepare email data
          title = os.environ['POST_TITLE']
          excerpt = os.environ.get('POST_EXCERPT', '')
          post_url = os.environ['POST_URL']
          
          # Create email body with excerpt and link
          email_body = f"""
          <h2>Someone made a new blog post! Check it out.</h2>
          <h3>{title}</h3>
          <p>{excerpt}</p>
          <p><a href="{post_url}">Read the full post →</a></p>
          """
          
          # Buttondown API endpoint
          url = 'https://api.buttondown.email/v1/emails'
          
          headers = {
              'Authorization': f'Token {os.environ["BUTTONDOWN_API_KEY"]}',
              'Content-Type': 'application/json'
          }
          
          data = {
              'subject': 'New Dolphin Donglers blog post!',
              'body': email_body,
          }
          
          # Send request
          response = requests.post(url, json=data, headers=headers)
          
          if response.status_code in [200, 201]:
              print(f"✓ Email sent successfully: {title}")
              print(f"Response: {response.json()}")
          else:
              print(f"✗ Failed to send email")
              print(f"Status code: {response.status_code}")
              print(f"Response: {response.text}")
              exit(1)
          EOF
